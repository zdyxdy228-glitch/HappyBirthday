<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç”Ÿæ—¥å¿«ä¹ - é­”æ³•ç²’å­ v3.0 (æœ€ç»ˆå…¸è—ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet">
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Noto Serif SC', serif;
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
        }
        
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .interactive-element { 
            pointer-events: auto; 
            cursor: pointer;
        }
        
        .input_video { display: none; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            z-index: 100; /* è¿™é‡Œçš„å±‚çº§æœ€é«˜ */
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }

        /* å¹æ°”è¿›åº¦æ¡ - ç¾åŒ– */
        #blow-meter-container {
            position: absolute;
            bottom: 15%; 
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        #blow-meter-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff9a9e 0%, #ff69b4 100%);
            border-radius: 10px;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px #ff69b4;
        }

        #blow-hint {
            position: absolute;
            bottom: 18%;
            width: 100%;
            text-align: center;
            font-size: 16px;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* æƒŠå–œå±‚æ ·å¼ä¼˜åŒ– */
        #surprise-layer {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 80; /* ç¡®ä¿æ¯”UIå±‚é«˜ï¼Œæ¯”é®ç½©ä½ */
            pointer-events: none; /* é»˜è®¤ä¸é˜»æŒ¡ */
        }
        
        /* æ¿€æ´»æ—¶çš„æ ·å¼ï¼Œå…è®¸ç‚¹å‡» */
        #surprise-layer.active {
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            transition: background 1s ease;
        }

        .card-transition {
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* å­—ä½“ç¾åŒ– */
        .font-handwriting { font-family: 'Dancing Script', cursive; }

        .pop-in { animation: popIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9) translateY(30px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* è§£å†³ç§»åŠ¨ç«¯æŒ‰é’®ç‚¹å‡»é—®é¢˜çš„å…³é”® CSS */
        .safe-click-area {
            z-index: 90;
            position: relative;
            touch-action: manipulation;
        }
    </style>
</head>
<body>

    <!-- è¿™é‡Œçš„éŸ³ä¹é“¾æ¥è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ -->
    <audio id="bgm" loop>
        <source src="./src/happy-birthday-155461.mp3" type="audio/mpeg">
    </audio>

    <video class="input_video"></video>
    <div id="canvas-container"></div>

    <!-- å¯åŠ¨é¡µ -->
    <div id="start-overlay">
        <div class="text-center max-w-md p-8 glass-panel mx-4 animate-float">
            <h1 class="text-6xl mb-4 font-handwriting text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-400 drop-shadow-lg">
                Happy Birthday
            </h1>
            <div class="space-y-4 text-gray-200 text-lg mb-8 font-light">
                <p>ğŸ‘‹ <b>ä¸¾èµ·åŒæ‰‹</b> å”¤é†’é­”æ³•</p>
                <p>ğŸ’¨ <b>æŒç»­å¹æ°”</b> è®¸ä¸‹å¿ƒæ„¿</p>
            </div>
            <button id="start-btn" class="safe-click-area px-12 py-4 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full font-bold text-xl hover:scale-105 active:scale-95 transition transform shadow-lg shadow-pink-500/50 text-white">
                è¿›å…¥é­”æ³•ä¸–ç•Œ
            </button>
            <div id="loading-text" class="hidden mt-4 text-pink-300 text-sm">æ­£åœ¨ç¼–ç»‡æ˜Ÿå…‰...</div>
        </div>
    </div>

    <!-- å¹æ°”æç¤ºä¸è¿›åº¦ -->
    <div id="blow-hint">ğŸ¤ è¯·å¯¹ç€éº¦å…‹é£ç”¨åŠ›å¹æ°” (3ç§’)</div>
    <div id="blow-meter-container">
        <div id="blow-meter-bar"></div>
    </div>

    <!-- ä¸» UI å±‚ -->
    <div id="ui-layer" style="display: none;">
        <!-- é¡¶éƒ¨çŠ¶æ€ -->
        <div class="flex justify-between items-start w-full">
            <div class="glass-panel px-4 py-2">
                <div id="status-dot" class="inline-block w-2 h-2 rounded-full bg-red-500 mr-2 shadow-[0_0_8px_red]"></div>
                <span id="status-text" class="text-xs md:text-sm text-gray-300 tracking-wider">SYSTEM READY</span>
            </div>
            <button id="music-btn" class="interactive-element p-3 glass-panel hover:bg-white/20 transition rounded-full active:scale-90">
                ğŸµ
            </button>
        </div>

        <!-- ä¸­å¿ƒå¤§å­— -->
        <div id="center-instruction" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none w-full z-0">
            <h2 id="instruction-text" class="text-5xl md:text-8xl font-bold text-white drop-shadow-[0_0_25px_rgba(255,105,180,0.6)] transition-all duration-700 font-handwriting">
                Raise Hands
            </h2>
            <p id="sub-instruction" class="mt-4 text-xl md:text-2xl text-pink-200 opacity-80 font-light tracking-[0.5em] uppercase">To Begin Magic</p>
        </div>

        <!-- åº•éƒ¨ MediaPipe è°ƒè¯•çª— (ä»…æ¡Œé¢æ˜¾ç¤ºï¼Œé¿å…æ‰‹æœºé®æŒ¡) -->
        <div class="absolute bottom-4 left-4 hidden md:block opacity-30 hover:opacity-100 transition duration-500">
            <div class="w-24 h-16 glass-panel overflow-hidden">
                 <canvas id="output_canvas" width="160" height="120" class="w-full h-full object-cover transform scale-x-[-1]"></canvas>
            </div>
        </div>
    </div>

    <!-- æƒŠå–œäº¤äº’å±‚ (ç‹¬ç«‹äº UI å±‚ï¼Œç¡®ä¿å±‚çº§æ­£ç¡®) -->
    <div id="surprise-layer" class="hidden">
        
        <!-- æ­¥éª¤ 1: æ­æ™“æŒ‰é’® -->
        <button id="reveal-btn" class="safe-click-area hidden px-10 py-5 bg-white text-pink-600 rounded-full font-bold text-2xl shadow-[0_0_60px_rgba(255,105,180,0.8)] hover:scale-105 transition-transform duration-300 animate-float">
            ğŸ æ‰“å¼€ç¤¼ç‰©
        </button>

        <!-- æ­¥éª¤ 2: å›¾ç‰‡å¡ç‰‡ -->
        <div id="card-step-1" class="hidden max-w-sm md:max-w-md w-full mx-6 glass-panel p-1 bg-gradient-to-br from-pink-500/40 to-purple-600/40 border border-white/30 shadow-2xl pop-in">
            <div class="bg-black/60 rounded-[1.2rem] p-6 backdrop-blur-md">
                <!-- å›¾ç‰‡å®¹å™¨ -->
                <div class="w-full aspect-[4/3] bg-gray-800 rounded-lg mb-6 overflow-hidden relative border border-white/10 shadow-inner">
                    <img src="https://images.unsplash.com/photo-1464349153912-6b4b3700a15f?q=80&w=800&auto=format&fit=crop" 
                         class="w-full h-full object-cover" 
                         alt="Cake">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <div class="absolute bottom-3 left-4 text-white/90 font-handwriting text-2xl">Happy Birthday!</div>
                </div>
                
                <div class="text-center">
                    <p class="text-gray-300 mb-6 font-light leading-relaxed">
                        è¿™ä¸ä»…ä»…æ˜¯ä¸€åœºæ•°å­—çƒŸèŠ±ï¼Œ<br>
                        æ›´æ˜¯ä¸ºä½ å‡†å¤‡çš„ä¸“å±æ—¶åˆ»ã€‚
                    </p>
                    <button id="next-surprise-btn" class="safe-click-area w-full py-3 bg-gradient-to-r from-pink-500 to-purple-600 rounded-xl font-bold text-white shadow-lg hover:brightness-110 active:scale-95 transition">
                        What's the surprise? âœ¨
                    </button>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤ 3: çº¯æ–‡æœ¬å¡ç‰‡ (ç‚¹å‡»ä¸Šé¢æŒ‰é’®åæ˜¾ç¤º) -->
        <div id="card-step-2" class="hidden max-w-sm md:max-w-md w-full mx-6 glass-panel p-1 bg-gradient-to-br from-purple-500/40 to-blue-600/40 border border-white/30 shadow-2xl pop-in">
            <div class="bg-black/60 rounded-[1.2rem] p-8 backdrop-blur-md text-center">
                <div class="mb-6 text-5xl">ğŸ’Œ</div>
                <h3 class="text-2xl font-bold text-pink-300 mb-6 font-handwriting">è‡´æœ€ç‰¹åˆ«çš„ä½ </h3>
                
                <div class="text-left text-gray-200 space-y-4 font-light leading-7 text-sm md:text-base border-l-2 border-pink-500/50 pl-4 mb-8">
                    <p>ç”Ÿæ—¥å¿«ä¹ï¼</p>
                    <p>æ„¿ä½ éå†å±±æ²³ï¼Œè§‰å¾—äººé—´å€¼å¾—ã€‚</p>
                    <p>æ„¿ä½ çœ¼é‡Œçš„æ˜Ÿæ˜Ÿæ°¸è¿œå‘äº®ï¼Œå¿ƒä¸­çš„å¤ªé˜³æ°¸è¿œæ»šçƒ«ã€‚</p>
                    <p>æ–°çš„ä¸€å²ï¼Œè¯·ç»§ç»­è‡ªç”±ã€çƒ­çƒˆã€é—ªé—ªå‘å…‰ï¼</p>
                </div>

                <button id="close-card-btn" class="safe-click-area px-8 py-2 rounded-full border border-white/30 text-gray-300 hover:bg-white/10 hover:text-white transition text-sm">
                    æ”¶èµ·å¡ç‰‡
                </button>
            </div>
        </div>

    </div>

    <script>
        /** --- å…¨å±€é…ç½® --- */
        const CONFIG = {
            particleCount: 5500, // ç¨å¾®å¢åŠ ç²’å­æ•°
            color: 0xff69b4,
            blowThreshold: 25,
            blowMaxDuration: 100 // çº¦3-4ç§’
        };

        const STATE = { IDLE: 0, COUNTDOWN: 1, CAKE: 2, BLOWING: 3, CELEBRATION: 4 };

        let currentState = STATE.IDLE;
        let particlesData = [];
        let scene, camera, renderer, particleSystem;
        let time = 0;
        let shapeCache = {}; 
        let blowProgress = 0;
        let audioContext, analyser;
        const bgm = document.getElementById('bgm');

        // DOM å…ƒç´ å¼•ç”¨
        const uiElements = {
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            mainText: document.getElementById('instruction-text'),
            subText: document.getElementById('sub-instruction'),
            blowMeter: document.getElementById('blow-meter-container'),
            blowBar: document.getElementById('blow-meter-bar'),
            blowHint: document.getElementById('blow-hint'),
            surpriseLayer: document.getElementById('surprise-layer'),
            revealBtn: document.getElementById('reveal-btn'),
            card1: document.getElementById('card-step-1'),
            card2: document.getElementById('card-step-2'),
            nextBtn: document.getElementById('next-surprise-btn'),
            closeBtn: document.getElementById('close-card-btn')
        };

        /* --- 1. Three.js åˆå§‹åŒ– --- */
        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50; // ç¨å¾®æ‹‰è¿œä¸€ç‚¹è§†è§’

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            preloadShapes();
            createParticles();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // é¢„è®¡ç®—å½¢çŠ¶æ•°æ® (è§£å†³å¡é¡¿çš„å…³é”®)
        function preloadShapes() {
            // ä½¿ç”¨ setTimeout å°†è®¡ç®—æ¨è¿Ÿåˆ°ä¸»çº¿ç¨‹ç©ºé—²æ—¶ï¼Œæˆ–è€…åˆ†å¸§è®¡ç®—
            setTimeout(() => {
                shapeCache['3'] = getShapePoints('text', '3');
                shapeCache['2'] = getShapePoints('text', '2');
                shapeCache['1'] = getShapePoints('text', '1');
                shapeCache['cake'] = getShapePoints('cake');
                
                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('start-overlay').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'flex';
                
                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                render();
            }, 100);
        }

        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(CONFIG.particleCount * 3);
            const colors = new Float32Array(CONFIG.particleCount * 3);
            const sizes = new Float32Array(CONFIG.particleCount);

            particlesData = [];
            const c = new THREE.Color(CONFIG.color);

            for (let i = 0; i < CONFIG.particleCount; i++) {
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                const z = (Math.random() - 0.5) * 100;

                positions[i * 3] = x;
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = z;

                colors[i * 3] = c.r; colors[i * 3 + 1] = c.g; colors[i * 3 + 2] = c.b;
                sizes[i] = Math.random() * 2;

                particlesData.push({
                    current: new THREE.Vector3(x, y, z),
                    target: new THREE.Vector3(x, y, z),
                    baseTarget: new THREE.Vector3(x, y, z), // ç”¨äºå¾…æœºåŠ¨ç”»çš„åŸºå‡†
                    velocity: new THREE.Vector3(0, 0, 0),
                    speed: 0.1,
                    type: 'bg',
                    targetColor: c.clone(),
                    noiseOffset: Math.random() * 100,
                    angle: Math.random() * Math.PI * 2, // æ—‹è½¬è§’åº¦
                    radius: 20 + Math.random() * 40     // æ—‹è½¬åŠå¾„
                });
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            const material = new THREE.PointsMaterial({
                size: 1.2,
                vertexColors: true,
                map: getCircleTexture(),
                transparent: true,
                opacity: 0.8,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });

            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
        }

        function getCircleTexture() {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx=c.getContext('2d');
            const g=ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(1,'rgba(255,255,255,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(c);
        }

        /* --- 2. å½¢çŠ¶ç”Ÿæˆç®—æ³•ä¼˜åŒ– (æ›´ç«‹ä½“çš„è›‹ç³•) --- */
        function getShapePoints(type, text) {
            const points = [];
            
            if (type === 'text') {
                const c = document.createElement('canvas'); c.width=200; c.height=200;
                const ctx=c.getContext('2d');
                ctx.font = 'bold 100px Arial';
                ctx.fillStyle = 'white'; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.fillText(text, 100, 100);
                const data = ctx.getImageData(0,0,200,200).data;
                for(let y=0; y<200; y+=3) {
                    for(let x=0; x<200; x+=3) {
                        if(data[(y*200+x)*4+3]>128) {
                            points.push({
                                vec: new THREE.Vector3((x-100)/3, -(y-100)/3, 0).multiplyScalar(2),
                                type: 'text', color: new THREE.Color(0xffffff)
                            });
                        }
                    }
                }
            } 
            else if (type === 'cake') {
                // ç¾åŒ–åçš„è›‹ç³•å‚æ•°ï¼šæ›´ä¸°æ»¡ï¼Œæ›´é«˜
                const layers = [
                    {y: -15, r: 18, h: 10, c: 0xFFB7C5}, // åº•å±‚å˜é«˜
                    {y: -5,  r: 13, h: 8,  c: 0xFF69B4}  // é¡¶å±‚å˜é«˜
                ];
                
                layers.forEach(l => {
                    // ä¾§é¢ç²’å­
                    for(let i=0; i<1000; i++) {
                        const theta = Math.random() * Math.PI * 2;
                        // åŠå¾„æœ‰å¾®å°éšæœºï¼Œå¢åŠ æ¯›èŒ¸èŒ¸çš„è´¨æ„Ÿ
                        const r = l.r * (0.9 + Math.random()*0.1); 
                        const h = Math.random() * l.h;
                        points.push({
                            vec: new THREE.Vector3(r*Math.cos(theta), l.y+h, r*Math.sin(theta)),
                            type: 'cake', color: new THREE.Color(l.c)
                        });
                    }
                    // é¡¶é¢å¥¶æ²¹è¦†ç›–
                    for(let i=0; i<400; i++) {
                        const theta = Math.random() * Math.PI * 2;
                        const r = Math.random() * l.r;
                        points.push({
                            vec: new THREE.Vector3(r*Math.cos(theta), l.y+l.h, r*Math.sin(theta)),
                            type: 'cake', color: new THREE.Color(0xFFFFFF)
                        });
                    }
                });

                // èœ¡çƒ› (æ›´é«˜æ›´ç»†)
                const candleY = layers[1].y + layers[1].h;
                for(let i=0; i<250; i++) {
                    const h = Math.random() * 10;
                    const r = Math.random() * 0.7;
                    const theta = Math.random() * Math.PI * 2;
                    // çº¢ç™½èºæ—‹çº¹
                    let col = (Math.sin(h*2 + theta)>0) ? new THREE.Color(0xFF0000) : new THREE.Color(0xFFFFFF);
                    points.push({
                        vec: new THREE.Vector3(r*Math.cos(theta), candleY+h, r*Math.sin(theta)),
                        type: 'candle', color: col
                    });
                }

                // ç«ç„° (æ›´æœ‰å±‚æ¬¡)
                const flameY = candleY + 10;
                for(let i=0; i<350; i++) {
                    const u = Math.random();
                    const h = u * 6; // ç«ç„°é«˜åº¦
                    const r = (1-u) * 1.8 * Math.random(); // åº•éƒ¨å®½é¡¶éƒ¨å°–
                    const theta = Math.random() * Math.PI * 2;
                    
                    let col = new THREE.Color(0xFFA500); // æ©™è‰²
                    if(u<0.2) col.setHex(0x0000FF); // è“ç„°å¿ƒ
                    else if(u>0.7) col.setHex(0xFF4500); // çº¢ç„°å°–

                    points.push({
                        vec: new THREE.Vector3(r*Math.cos(theta), flameY+h, r*Math.sin(theta)),
                        type: 'flame', color: col
                    });
                }
            }
            return points;
        }

        function transitionTo(key) {
            const targets = shapeCache[key] || [];
            particlesData.forEach((p, i) => {
                if (i < targets.length) {
                    p.baseTarget.copy(targets[i].vec);
                    p.target.copy(targets[i].vec);
                    p.type = targets[i].type;
                    p.targetColor = targets[i].color;
                    
                    // åˆ‡æ¢æ—¶çš„çˆ†ç‚¸æ•ˆæœï¼šç»™ä¸€ä¸ªéšæœºé€Ÿåº¦å‘é‡
                    const explodeForce = 3; 
                    p.current.add(new THREE.Vector3(
                        (Math.random()-0.5)*explodeForce, 
                        (Math.random()-0.5)*explodeForce, 
                        (Math.random()-0.5)*explodeForce
                    ));
                } else {
                    // å¤šä½™ç²’å­ä½œä¸ºèƒŒæ™¯æ˜Ÿç©º
                    const angle = Math.random() * Math.PI * 2;
                    const r = 40 + Math.random() * 40;
                    p.baseTarget.set(r*Math.cos(angle), (Math.random()-0.5)*60, r*Math.sin(angle));
                    p.target.copy(p.baseTarget);
                    p.type = 'bg';
                    p.targetColor = new THREE.Color(0x222222);
                }
            });
        }

        /* --- 3. æ ¸å¿ƒåŠ¨ç”»å¾ªç¯ --- */
        function updateParticles() {
            const positions = particleSystem.geometry.attributes.position.array;
            const colors = particleSystem.geometry.attributes.color.array;
            const sizes = particleSystem.geometry.attributes.size.array;
            time += 0.02;

            const blowInfluence = blowProgress / 100;

            for (let i = 0; i < CONFIG.particleCount; i++) {
                const p = particlesData[i];
                let target = p.target.clone();

                // === éœ€æ±‚ï¼šå¾…æœºçŠ¶æ€ç²’å­æ—‹è½¬ (èºæ—‹æ˜Ÿç³»æ•ˆæœ) ===
                if (currentState === STATE.IDLE) {
                    // è®¡ç®—èºæ—‹è¿åŠ¨
                    const angle = p.angle + time * 0.1; // æ—‹è½¬é€Ÿåº¦
                    const r = p.radius + Math.sin(time + i)*2; // å‘¼å¸æ„ŸåŠå¾„
                    target.x = Math.cos(angle) * r;
                    target.z = Math.sin(angle) * r;
                    target.y = p.baseTarget.y + Math.sin(time + x * 0.1) * 5; // ä¸Šä¸‹æµ®åŠ¨
                }

                // ç«ç„°ç‰©ç†æ•ˆæœ
                if (p.type === 'flame') {
                    const noise = Math.sin(time * 6 + p.noiseOffset) * 0.6;
                    target.x += noise;
                    
                    // å¹æ°”æˆ–åº†ç¥æ—¶é£èµ°
                    if (blowInfluence > 0.1 || currentState === STATE.CELEBRATION) {
                        let lift = blowInfluence * 25;
                        if(currentState === STATE.CELEBRATION) lift = 60; // å½»åº•é£èµ°
                        
                        target.y += lift;
                        target.x += (Math.random()-0.5) * lift * 0.8;
                        p.targetColor.lerp(new THREE.Color(0x444444), 0.15);
                    }
                }

                // ç‰©ç†æ’å€¼ (Spring like lerp)
                p.current.lerp(target, 0.08);

                positions[i*3] = p.current.x;
                positions[i*3+1] = p.current.y;
                positions[i*3+2] = p.current.z;

                colors[i*3] += (p.targetColor.r - colors[i*3]) * 0.1;
                colors[i*3+1] += (p.targetColor.g - colors[i*3+1]) * 0.1;
                colors[i*3+2] += (p.targetColor.b - colors[i*3+2]) * 0.1;

                if (p.type === 'flame' && (blowInfluence > 0.1 || currentState === STATE.CELEBRATION)) {
                    sizes[i] = Math.max(0, 1.5 * (1 - blowInfluence)); 
                    if(currentState === STATE.CELEBRATION) sizes[i] *= 0.9;
                } else {
                    sizes[i] = 1.2 + Math.sin(time + i) * 0.3;
                }
            }

            particleSystem.geometry.attributes.position.needsUpdate = true;
            particleSystem.geometry.attributes.color.needsUpdate = true;
            particleSystem.geometry.attributes.size.needsUpdate = true;

            // æ•´ä½“åœºæ™¯æ—‹è½¬
            if(currentState === STATE.IDLE) {
                // å¾…æœºæ—¶ä¸è½¬æ•´ä¸ªåœºæ™¯ï¼Œè€Œæ˜¯ç²’å­è‡ªå·±åœ¨è½¬
                particleSystem.rotation.y = 0;
            } else {
                particleSystem.rotation.y = Math.sin(time * 0.15) * 0.15;
            }
        }

        /* --- 4. ä¸šåŠ¡æµç¨‹é€»è¾‘ --- */
        let transitionLock = false; // è§£å†³æ‰‹åŠ¿è¯†åˆ«å¡é¡¿çš„é”

        function startSequence() {
            if (currentState !== STATE.IDLE || transitionLock) return;
            transitionLock = true; // é”å®šï¼Œé˜²æ­¢é‡å¤è§¦å‘
            
            currentState = STATE.COUNTDOWN;
            
            uiElements.statusText.innerText = "GESTURE DETECTED";
            uiElements.statusText.className = "text-xs md:text-sm text-green-400 font-bold tracking-wider";
            uiElements.statusDot.className = "inline-block w-2 h-2 rounded-full bg-green-500 mr-2 shadow-[0_0_8px_#0f0]";
            
            // å€’æ•°é€»è¾‘
            let count = 3;
            uiElements.mainText.innerText = "3";
            uiElements.subText.innerText = "Make a Wish";
            transitionTo('3');

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    uiElements.mainText.innerText = count;
                    transitionTo(count.toString());
                } else {
                    clearInterval(timer);
                    showCake();
                }
            }, 1200);
        }

        function showCake() {
            currentState = STATE.BLOWING;
            transitionTo('cake');
            
            uiElements.mainText.innerText = "Happy Birthday";
            uiElements.mainText.className = "text-5xl md:text-8xl font-bold text-pink-300 drop-shadow-[0_0_20px_rgba(255,105,180,0.8)] font-handwriting pop-in";
            uiElements.subText.innerText = "";
            uiElements.statusText.innerText = "MIC LISTENING...";
            
            uiElements.blowMeter.style.opacity = '1';
            uiElements.blowHint.style.opacity = '1';
        }

        function successCelebration() {
            currentState = STATE.CELEBRATION;
            uiElements.statusText.innerText = "WISH GRANTED";
            uiElements.blowMeter.style.opacity = '0';
            uiElements.blowHint.style.opacity = '0';
            
            // ä¿ç•™è›‹ç³•ï¼Œç‚¸é£å…¶ä»–
            particlesData.forEach(p => {
                if (p.type === 'cake' || p.type === 'candle') {
                    p.target.y += Math.sin(p.current.x * 0.5) * 0.5; // æ¬¢å‘¼è·³åŠ¨
                    p.targetColor.offsetHSL(0, 0, 0.2); // å˜äº®
                } else if (p.type !== 'flame') {
                    // èƒŒæ™¯çˆ†ç‚¸
                    p.type = 'bg';
                    p.targetColor = new THREE.Color().setHSL(Math.random(), 0.8, 0.6);
                    const angle = Math.random() * Math.PI * 2;
                    const r = 60 + Math.random() * 80;
                    p.target.set(r*Math.cos(angle), (Math.random()-0.5)*80, r*Math.sin(angle));
                }
            });

            uiElements.mainText.innerText = "ğŸ‰";
            
            // æ˜¾ç¤ºæƒŠå–œå±‚
            setTimeout(() => {
                uiElements.surpriseLayer.classList.remove('hidden');
                uiElements.surpriseLayer.classList.add('active'); // å¼€å¯èƒŒæ™¯æ¨¡ç³Š
                uiElements.revealBtn.classList.remove('hidden');
            }, 1500);
        }

        /* --- 5. åŒå±‚å¡ç‰‡é€»è¾‘ --- */
        uiElements.revealBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜²æ­¢ç‚¹é€
            uiElements.revealBtn.classList.add('hidden');
            uiElements.card1.classList.remove('hidden');
        });

        uiElements.nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // å¡ç‰‡1 ç¿»è½¬éšè—
            uiElements.card1.style.transform = "rotateY(90deg) scale(0.8)";
            uiElements.card1.style.opacity = "0";
            
            setTimeout(() => {
                uiElements.card1.classList.add('hidden');
                uiElements.card2.classList.remove('hidden'); // æ˜¾ç¤ºå¡ç‰‡2
            }, 300); // ç­‰å¾…åŠ¨ç”»
        });

        uiElements.closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            uiElements.card2.classList.add('hidden');
            // é‡ç½®çŠ¶æ€ï¼Œå¯ä»¥å†æ¬¡ç‚¹å¼€
            uiElements.revealBtn.classList.remove('hidden');
            // é‡ç½®å¡ç‰‡1æ ·å¼ä»¥ä¾¿ä¸‹æ¬¡æ˜¾ç¤º
            uiElements.card1.style.transform = "";
            uiElements.card1.style.opacity = "";
        });

        /* --- 6. éŸ³é¢‘ä¸ç¡¬ä»¶ --- */
        function initAudio() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                checkAudio();
            }).catch(e => {
                uiElements.statusText.innerText = "MIC DENIED - TAP SCREEN";
                document.addEventListener('touchstart', () => { if(currentState===STATE.BLOWING) blowProgress+=5; });
                document.addEventListener('click', () => { if(currentState===STATE.BLOWING) blowProgress+=5; });
            });
        }

        function checkAudio() {
            requestAnimationFrame(checkAudio);
            if (currentState !== STATE.BLOWING || !analyser) return;
            
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            let sum = 0; 
            for(let i=0; i<data.length; i++) sum += data[i];
            const avg = sum / data.length;

            // å¹æ°”æ£€æµ‹é€»è¾‘
            if (avg > CONFIG.blowThreshold) {
                isBlowing = true;
                blowProgress += 0.5; // é€Ÿåº¦é€‚ä¸­
            } else {
                isBlowing = false;
                blowProgress -= 0.3; // ç¼“æ…¢å›è½
            }
            blowProgress = Math.max(0, Math.min(100, blowProgress));
            
            uiElements.blowBar.style.width = blowProgress + '%';
            if (blowProgress >= 100) successCelebration();
        }

        document.getElementById('start-btn').addEventListener('click', function() {
            const btn = this;
            btn.innerHTML = '<span class="animate-pulse">Loading...</span>';
            btn.disabled = true;
            document.getElementById('loading-text').style.display = 'block';
            
            bgm.volume = 0.5;
            bgm.play().catch(e => console.log("Auto-play blocked"));

            initAudio();
            initCamera();
            initThree(); // åˆå§‹åŒ– Three å¹¶å¼€å§‹é¢„è®¡ç®—
        });
        
        document.getElementById('music-btn').addEventListener('click', () => {
            if (bgm.paused) bgm.play(); else bgm.pause();
        });

        function initCamera() {
            const video = document.getElementsByClassName('input_video')[0];
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({
                maxNumHands: 1, // å‡å°‘åˆ°1åªæ‰‹ä»¥ä¼˜åŒ–æ€§èƒ½
                modelComplexity: 0, // ä½¿ç”¨ç²¾ç®€æ¨¡å‹å‡å°‘å¡é¡¿
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            let lastDetectionTime = 0;
            hands.onResults((results) => {
                const now = Date.now();
                // é™åˆ¶æ£€æµ‹é¢‘ç‡ï¼Œé˜²æ­¢UIçº¿ç¨‹é˜»å¡
                if (now - lastDetectionTime < 50) return; 
                lastDetectionTime = now;

                if (currentState === STATE.IDLE && results.multiHandLandmarks.length > 0) {
                    startSequence();
                }
                
                // ç»˜åˆ¶è°ƒè¯•
                const ctx = document.getElementById('output_canvas').getContext('2d');
                ctx.clearRect(0, 0, 160, 120);
                if(results.multiHandLandmarks) {
                    for (const l of results.multiHandLandmarks) drawConnectors(ctx, l, HAND_CONNECTIONS, {color: '#ff69b4', lineWidth: 2});
                }
            });

            const camera = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240 // é™ä½åˆ†è¾¨ç‡ä»¥æé«˜æ€§èƒ½
            });
            camera.start();
        }

        function render() {
            requestAnimationFrame(render);
            updateParticles();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>